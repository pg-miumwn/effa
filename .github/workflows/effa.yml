name: Update CSS to OUR CDN

on:
  schedule:
    - cron: '0 0 */2 * *' # Every two days at 00:00 UTC
  workflow_dispatch:

jobs:
  update-css:
    runs-on: ubuntu-latest
    env:
      NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      NETLIFY_TOKEN: ${{ secrets.NETLIFY_TOKEN }}
      PAF_NPM_URL: ${{ secrets.PAF_NPM_URL }}
      PAF_CSS_URL_TEMPLATE: ${{ secrets.PAF_CSS_URL_TEMPLATE }}
      PAF_TOKEN: ${{ secrets.PAF_TOKEN }}
      CSS_FILE: ${{ secrets.CSS_FILE_PATH }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Fetch latest version
        id: PAF_version
        run: |
          echo "Fetching latest version..."
          VERSION=$(curl -s "$PAF_NPM_URL" | node -pe "JSON.parse(require('fs').readFileSync(0,'utf8')).version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Fetch and process CSS
        run: |
          VERSION=${{ steps.PAF_version.outputs.version }}
          CSS_URL=${PAF_CSS_URL_TEMPLATE//\{version\}/$VERSION}
          CSS_URL=${CSS_URL//\{token\}/$PAF_TOKEN}

          mkdir -p $(dirname $CSS_FILE)
          curl -s "$CSS_URL" -o "$CSS_FILE"

          # Replace relative webfont paths
          sed -i "s|\.\./webfonts/|${CSS_URL%/css/pro.min.css}/webfonts/|g" "$CSS_FILE"
          echo "CSS processed and saved to $CSS_FILE"

      - name: Upload CSS to Netlify
        run: |
          RESPONSE=$(curl -s -X POST https://api.netlify.com/api/v1/sites/$NETLIFY_SITE_ID/deploys \
            -H "Authorization: Bearer $NETLIFY_TOKEN" \
            -F "files[$CSS_FILE]=@$CSS_FILE")
          echo "Deploy response: $RESPONSE"
