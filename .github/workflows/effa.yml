name: Update CSS to OUR CDN
on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 */2 * *' # Every two days at 00:00 UTC
  workflow_dispatch:
  
jobs:
  update-css:
    runs-on: ubuntu-latest
    env:
      NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      NETLIFY_TOKEN: ${{ secrets.NETLIFY_TOKEN }}
      PAF_NPM_URL: ${{ secrets.PAF_NPM_URL }}
      PAF_CSS_URL_TEMPLATE: ${{ secrets.PAF_CSS_URL_TEMPLATE }}
      PAF_TOKEN: ${{ secrets.PAF_TOKEN }}
      CSS_FILE_PATH: ${{ secrets.CSS_FILE_PATH }}
      FONT_DIR: ${{ secrets.FONT_DIR }}
      CSS_NAME: ${{ secrets.CSS_NAME }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Fetch latest version
        id: PAF_version
        run: |
          # Fetch latest version from npm
          VERSION=$(curl -s "$PAF_NPM_URL" | node -pe "JSON.parse(require('fs').readFileSync(0,'utf8')).version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      - name: Fetch and process CSS
        run: |
          VERSION=${{ steps.PAF_version.outputs.version }}
          # Build CSS URL from template
          CSS_URL=${PAF_CSS_URL_TEMPLATE//\{version\}/$VERSION}
          CSS_URL=${CSS_URL//\{token\}/$PAF_TOKEN}
          # Build full local path including version
          OUTPUT_FILE="${VERSION}/${CSS_FILE_PATH}"
          mkdir -p $(dirname "$OUTPUT_FILE")
          curl -s "$CSS_URL" -o "$OUTPUT_FILE"
          CSS_BASE_URL="${CSS_URL%/css/*}"
          sed -i "s|\.\./${FONT_DIR}/|$CSS_BASE_URL/$FONT_DIR/|g" "$OUTPUT_FILE"
          echo "CSS processed and saved to $OUTPUT_FILE"
      - name: Install Netlify CLI
        run: npm install -g netlify-cli
      - name: Deploy CSS to Netlify
        run: |
          VERSION="${{ steps.PAF_version.outputs.version }}"
          LOCAL_FILE="${VERSION}/${CSS_FILE_PATH}"
          
          # Create a temporary deploy directory
          DEPLOY_DIR="netlify-deploy"
          mkdir -p "$DEPLOY_DIR/$VERSION/$(dirname $CSS_FILE_PATH)"
          cp "$LOCAL_FILE" "$DEPLOY_DIR/$VERSION/$CSS_FILE_PATH"
          
          echo "Deploying $LOCAL_FILE to Netlify site..."
          
          # Deploy using Netlify CLI in JSON mode and suppress output
          DEPLOY_OUTPUT=$(netlify deploy \
            --dir="$DEPLOY_DIR" \
            --site="$NETLIFY_SITE_ID" \
            --auth="$NETLIFY_TOKEN" \
            --prod \
            --message="Update CSS version $VERSION" \
            --json 2>/dev/null)

          # Optional: you can parse DEPLOY_OUTPUT if needed
          # For example, get the published URL:
          PUBLISHED_URL=$(echo "$DEPLOY_OUTPUT" | node -pe "JSON.parse(require('fs').readFileSync(0,'utf8')).url")
          
          echo "âœ… Successfully deployed CSS version for latest version"
